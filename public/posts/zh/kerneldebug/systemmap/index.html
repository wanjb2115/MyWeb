<!DOCTYPE html>
<html  dir="ltr" lang="zh" data-theme=""><head>
    <title> 万家兵 | 通过System Map调试分析Kernel panics和Kernel Oopses </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.68.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="自由 | 快乐">
    
    
    
    <link rel="stylesheet"
        href="/css/style.min.43c0b080cb611c20f662cb7054828a33868d349cc715634a6f60ab7ca2305ecd.css"
        integrity="sha256-Q8CwgMthHCD2YstwVIKKM4aNNJzHFWNKb2CrfKIwXs0="
        crossorigin="anonymous"
        type="text/css">
    
    
    <link rel="stylesheet"
        href="/css/markupHighlight.min.cc84ed683057cc175ddfa738ea6ba2d5c882b95cb64f50bf9be918cb3791887b.css"
        integrity="sha256-zITtaDBXzBdd36c46mui1ciCuVy2T1C/m&#43;kYyzeRiHs="
        crossorigin="anonymous"
        type="text/css">
    
    <link rel="stylesheet" 
    href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="canonical" href="/posts/zh/kerneldebug/systemmap/">

    
    
    
    
    <script type="text/javascript"
            src="/js/anatole-header.min.d8599ee07b7d3f11bafbac30657ccc591e8d7fd36a9f580cd4c09e24e0e4a971.js"
            integrity="sha256-2Fme4Ht9PxG6&#43;6wwZXzMWR6Nf9Nqn1gM1MCeJODkqXE="
            crossorigin="anonymous"></script>


    
        
        
        <script type="text/javascript"
                src="/js/anatole-theme-switcher.min.2c507695a28320822cee065375387eac9bc9f3dfd49d4dcf84bbaca2b8efb30c.js"
                integrity="sha256-LFB2laKDIIIs7gZTdTh&#43;rJvJ89/UnU3PhLusorjvsww="
                crossorigin="anonymous"></script>
    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="通过System Map调试分析Kernel panics和Kernel Oopses"/>
<meta name="twitter:description" content="通过System Map调试分析Kernel panics和Kernel Oopses"/>


    

</head>
<body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="/image/head.jpg" alt="profile picture">
            <h3 title=""><a href="/">冰冰的小屋</a></h3>
            <div class="description">
                <p>自由 | 快乐</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; 万家兵  2020-2021 鲁ICP备20020558号-1 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">主页</a></li>
        
            
            <li><a 
                   href="/posts/"
                        
                   title="">博客</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">关于</a></li>
        
        
            
                <li><a href="/"
                       title="中文">中文</a>
                </li>
            
                <li><a href="/en/"
                       title="EN">EN</a>
                </li>
            
        
        
            <li class="theme-switch-item">
                <a class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post  animated fadeInDown ">
        <div class="post-content">
            
            <div class="post-title">
                <h3>通过System Map调试分析Kernel panics和Kernel Oopses</h3>
                
            </div>

            <h1 id="linux-kernel调试介绍">Linux kernel调试介绍：</h1>
<hr>
<p>有多种多样调试kernel的方式，例如打印相关信息，使用kernel符号表，使用kernel Debugger， 但是本文</p>
<p>描述了一些技巧和技术帮助解释一个Oops信息和kernel panic。在这之前，我们应该明白什么是Kernel OOPS和panic。</p>
<p><strong>Kernel panic</strong> 是当操作系统检测到一个内部致命错误，因为检测到的运行时系统故障，它无法安全地恢复并强制系统挂起/重新引导系统。</p>
<p>Kernel panic的行为是可以通过设置运行时系统配置，例如hung task，使之变为可控的。这就是kernel panic。</p>
<p><strong>Oops</strong>是执行的kernel 异常处理程序，包括被定义为异常指令的宏，例如BUG()。每一个异常有一个特定的数字。</p>
<p>一些“oops”足够严重，以至于kernel决定执行panic特性立即停止系统运作。这是一次由调用panic的kernel crash。</p>
<p>当一个Kernel Oops在一个运行的kernel中发生，在屏幕上会输出Oops信息，例如 ([ 67.994624] Internal error: Oops: 5 [#1] XXXXXXXXXXX)。 这个Oops信息包含：</p>
<ul>
<li>各个CPU寄存器的值</li>
<li>造成这次失败的函数的地址，如PC</li>
<li>栈</li>
<li>当前正在正在执行的进程名称
通过使用这个OOPS状态，你可以开始调试特定的kernel问题。然而，有些时候，仅根据Oops信息是不够的。</li>
</ul>
<h2 id="如何通过systemmap去解释oopes">如何通过System.map去解释Oopes</h2>
<p>在Linux中，Syste.map文件是kernel使用的符号表。</p>
<p>当需要某个符号名的地址，或某个地址的符号名时，System.map文件就是必要的。而且该文件对调试kernel panic和kernel oopes十分有效。当CONFIG_KALLSYMS被启用时，Kernel自己进行address-to-name的翻译，所以一些如ksymoops的工具就不需要了。</p>
<p>更多细节信息可以参考：<a href="https://en.wikipedia.org/wiki/System.map">System.map</a>.</p>
<p>注意：System.map内的地址可能每次都会变化，换句话说，每次构建kernel都会生成新的System.map，但是必须有已报告kernel panic/Oopes的同一Linux内核的System.map才能调试问题。</p>
<p>注意在logs中kernel调用栈内，，kernel会寻找与要分析的地址最接近的符号，由于内联，静态和优化，并非所有的函数符号都是可用的，因此有时候报告的函数名称并不是故障所在的位置。</p>
<h2 id="如何调试kernel-panics和oopes">如何调试kernel panics和Oopes</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">67.994406<span style="color:#f92672">]</span> Unable to handle kernel paging request at virtual address 02120bc4
<span style="color:#f92672">[</span>   67.994495<span style="color:#f92672">]</span> pgd <span style="color:#f92672">=</span> <span style="color:#ae81ff">94240000</span>
<span style="color:#f92672">[</span>   67.994553<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>02120bc4<span style="color:#f92672">]</span> *pgd<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
<span style="color:#f92672">[</span>   67.994624<span style="color:#f92672">]</span> Internal error: Oops: <span style="color:#ae81ff">5</span> <span style="color:#f92672">[</span><span style="color:#75715e">#1] PREEMPT SMP ARM</span>
<span style="color:#f92672">[</span>   67.994926<span style="color:#f92672">]</span> CPU: <span style="color:#ae81ff">0</span>    Not tainted  <span style="color:#f92672">(</span>3.8.13.23-XXXXXXXX <span style="color:#75715e">#1)</span>
<span style="color:#f92672">[</span>   67.994996<span style="color:#f92672">]</span> PC is at add_range+0x14/0x6c
<span style="color:#f92672">[</span>   67.995056<span style="color:#f92672">]</span> LR is at XXXXXXX+0x38/0x44
<span style="color:#f92672">[</span>   67.995117<span style="color:#f92672">]</span> pc : <span style="color:#f92672">[</span>&lt;80049F3C&gt;<span style="color:#f92672">]</span>    lr : <span style="color:#f92672">[</span>&lt;8004a1ec&gt;<span style="color:#f92672">]</span>    psr: <span style="color:#ae81ff">20000013</span>
<span style="color:#f92672">[</span>   67.995117<span style="color:#f92672">]</span> sp : 9423fd90  ip : 9423fda8  fp : 9423fda4
<span style="color:#f92672">[</span>   67.995176<span style="color:#f92672">]</span> r10: <span style="color:#ae81ff">00000000</span>  r9 : 9423ff60  r8 : 8000da84
<span style="color:#f92672">[</span>   67.995233<span style="color:#f92672">]</span> r7 : 000041fd  r6 : <span style="color:#ae81ff">00000081</span>  r5 : aa068088  r4 : aa068088
<span style="color:#f92672">[</span>   67.995290<span style="color:#f92672">]</span> r3 : ac8ceb80  r2 : 021ab618  r1 : <span style="color:#ae81ff">00000000</span>  r0 : 02120bc0
<span style="color:#f92672">[</span>   67.995348<span style="color:#f92672">]</span> Flags: nzCv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
<span style="color:#f92672">[</span>   67.995406<span style="color:#f92672">]</span> Control: 10c5387d  Table: 2424004a  DAC: <span style="color:#ae81ff">00000015</span>
<span style="color:#f92672">[</span>   67.995462<span style="color:#f92672">]</span> Process cat <span style="color:#f92672">(</span>pid: 1352, stack limit <span style="color:#f92672">=</span> 0x9423e238<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>   67.995518<span style="color:#f92672">]</span> Stack: <span style="color:#f92672">(</span>0x9423fd90 to 0x94240000<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>   67.995577<span style="color:#f92672">]</span> fd80:                                     aa068088 aa068088 9423fdb4 9423fda8

</code></pre></div><p>这是一个kernel在“add_range”函数崩溃时的kernel回溯，让我们来一步一步地分析。</p>
<ol>
<li>Crash每次都发生在下面的位置：</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PC is at add_range +0x14/0x6c
</code></pre></div><ol start="2">
<li>筛选(grep)/寻找 add_range()函数在System.map文件中，记录下符号名称对应的地址，例如80049f28</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#Linux-Kernel # grep add_range System.map</span> 
80049f28 T add_range
</code></pre></div></div>
        <div class="post-footer">
            <div class="info">
                <span class="separator"><a class="category" href="/categories/%E5%86%85%E6%A0%B8%E4%B9%8B%E6%97%85/">内核之旅</a></span>
                <span class="separator"><a class="tag" href="/tags/linuxkernel%E8%B0%83%E8%AF%95/">LinuxKernel调试</a></span>
            </div>
        </div>

        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script></body>

</html>
